<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/hook.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-1.gettingStarted.html">Getting Started</a></li><li><a href="tutorial-2.schemaDefinitionGuide.html">Model schema definition</a></li><li><a href="tutorial-3.quering.html">Quering</a></li><li><a href="tutorial-4.instances.html">Instances</a></li><li><a href="tutorial-5.hooks.html">Hooks</a></li><li><a href="tutorial-6.errors.html">Errors</a></li><li><a href="tutorial-7.customizingDocumentsKey.html">Customizing Document's Key</a></li></ul><h3>Classes</h3><ul><li><a href="CouchbaseODM.html">CouchbaseODM</a><ul class='methods'><li data-type='method'><a href="CouchbaseODM.html#define">define</a></li></ul></li><li><a href="Document.html">Document</a><ul class='methods'><li data-type='method'><a href="Document.html#getCAS">getCAS</a></li><li data-type='method'><a href="Document.html#getData">getData</a></li><li data-type='method'><a href="Document.html#getGeneratedKey">getGeneratedKey</a></li><li data-type='method'><a href="Document.html#getKey">getKey</a></li><li data-type='method'><a href="Document.html#getSerializedData">getSerializedData</a></li><li data-type='method'><a href="Document.html#getStorageAdapter">getStorageAdapter</a></li><li data-type='method'><a href="Document.html#hasCAS">hasCAS</a></li><li data-type='method'><a href="Document.html#insert">insert</a></li><li data-type='method'><a href="Document.html#remove">remove</a></li><li data-type='method'><a href="Document.html#replace">replace</a></li><li data-type='method'><a href="Document.html#setCAS">setCAS</a></li><li data-type='method'><a href="Document.html#setData">setData</a></li><li data-type='method'><a href="Document.html#setKey">setKey</a></li><li data-type='method'><a href="Document.html#touch">touch</a></li></ul></li><li><a href="DocumentError.html">DocumentError</a></li><li><a href="Hook.html">Hook</a><ul class='methods'><li data-type='method'><a href="Hook.html#addHook">addHook</a></li><li data-type='method'><a href="Hook.html#afterCreate">afterCreate</a></li><li data-type='method'><a href="Hook.html#afterDestroy">afterDestroy</a></li><li data-type='method'><a href="Hook.html#afterFailedIndexRemoval">afterFailedIndexRemoval</a></li><li data-type='method'><a href="Hook.html#afterFailedRollback">afterFailedRollback</a></li><li data-type='method'><a href="Hook.html#afterGet">afterGet</a></li><li data-type='method'><a href="Hook.html#afterRollback">afterRollback</a></li><li data-type='method'><a href="Hook.html#afterUpdate">afterUpdate</a></li><li data-type='method'><a href="Hook.html#afterValidate">afterValidate</a></li><li data-type='method'><a href="Hook.html#beforeCreate">beforeCreate</a></li><li data-type='method'><a href="Hook.html#beforeDestroy">beforeDestroy</a></li><li data-type='method'><a href="Hook.html#beforeGet">beforeGet</a></li><li data-type='method'><a href="Hook.html#beforeRollback">beforeRollback</a></li><li data-type='method'><a href="Hook.html#beforeUpdate">beforeUpdate</a></li><li data-type='method'><a href="Hook.html#beforeValidate">beforeValidate</a></li><li data-type='method'><a href="Hook.html#beforeValidate">beforeValidate</a></li><li data-type='method'><a href="Hook.html#removeHook">removeHook</a></li><li data-type='method'><a href="Hook.html#runHooks">runHooks</a></li></ul></li><li><a href="HookError.html">HookError</a></li><li><a href="IncrementalKey.html">IncrementalKey</a><ul class='methods'><li data-type='method'><a href="IncrementalKey.html#clone">clone</a></li><li data-type='method'><a href="IncrementalKey.html#generate">generate</a></li><li data-type='method'><a href="IncrementalKey.html#getId">getId</a></li><li data-type='method'><a href="IncrementalKey.html#getOptions">getOptions</a></li><li data-type='method'><a href="IncrementalKey.html#isGenerated">isGenerated</a></li><li data-type='method'><a href="IncrementalKey.html#parse">parse</a></li><li data-type='method'><a href="IncrementalKey.html#setId">setId</a></li><li data-type='method'><a href="IncrementalKey.html#toString">toString</a></li></ul></li><li><a href="Instance.html">Instance</a><ul class='methods'><li data-type='method'><a href="Instance.html#clone">clone</a></li><li data-type='method'><a href="Instance.html#cloneData">cloneData</a></li><li data-type='method'><a href="Instance.html#destroy">destroy</a></li><li data-type='method'><a href="Instance.html#getCAS">getCAS</a></li><li data-type='method'><a href="Instance.html#getData">getData</a></li><li data-type='method'><a href="Instance.html#getGeneratedKey">getGeneratedKey</a></li><li data-type='method'><a href="Instance.html#getKey">getKey</a></li><li data-type='method'><a href="Instance.html#getSerializedData">getSerializedData</a></li><li data-type='method'><a href="Instance.html#getStorageAdapter">getStorageAdapter</a></li><li data-type='method'><a href="Instance.html#hasCAS">hasCAS</a></li><li data-type='method'><a href="Instance.html#insert">insert</a></li><li data-type='method'><a href="Instance.html#refresh">refresh</a></li><li data-type='method'><a href="Instance.html#remove">remove</a></li><li data-type='method'><a href="Instance.html#replace">replace</a></li><li data-type='method'><a href="Instance.html#sanitize">sanitize</a></li><li data-type='method'><a href="Instance.html#save">save</a></li><li data-type='method'><a href="Instance.html#setCAS">setCAS</a></li><li data-type='method'><a href="Instance.html#setData">setData</a></li><li data-type='method'><a href="Instance.html#setKey">setKey</a></li><li data-type='method'><a href="Instance.html#toJSON">toJSON</a></li><li data-type='method'><a href="Instance.html#touch">touch</a></li><li data-type='method'><a href="Instance.html#update">update</a></li></ul></li><li><a href="InstanceError.html">InstanceError</a></li><li><a href="Key.html">Key</a><ul class='methods'><li data-type='method'><a href="Key.html#generate">generate</a></li><li data-type='method'><a href="Key.html#getId">getId</a></li><li data-type='method'><a href="Key.html#getOptions">getOptions</a></li><li data-type='method'><a href="Key.html#isGenerated">isGenerated</a></li><li data-type='method'><a href="Key.html#parse">parse</a></li><li data-type='method'><a href="Key.html#setId">setId</a></li><li data-type='method'><a href="Key.html#toString">toString</a></li></ul></li><li><a href="KeyError.html">KeyError</a></li><li><a href="Model.html">Model</a><ul class='methods'><li data-type='method'><a href="Model.html#addHook">addHook</a></li><li data-type='method'><a href="Model.html#afterCreate">afterCreate</a></li><li data-type='method'><a href="Model.html#afterDestroy">afterDestroy</a></li><li data-type='method'><a href="Model.html#afterFailedIndexRemoval">afterFailedIndexRemoval</a></li><li data-type='method'><a href="Model.html#afterFailedRollback">afterFailedRollback</a></li><li data-type='method'><a href="Model.html#afterGet">afterGet</a></li><li data-type='method'><a href="Model.html#afterRollback">afterRollback</a></li><li data-type='method'><a href="Model.html#afterUpdate">afterUpdate</a></li><li data-type='method'><a href="Model.html#afterValidate">afterValidate</a></li><li data-type='method'><a href="Model.html#beforeCreate">beforeCreate</a></li><li data-type='method'><a href="Model.html#beforeDestroy">beforeDestroy</a></li><li data-type='method'><a href="Model.html#beforeGet">beforeGet</a></li><li data-type='method'><a href="Model.html#beforeRollback">beforeRollback</a></li><li data-type='method'><a href="Model.html#beforeUpdate">beforeUpdate</a></li><li data-type='method'><a href="Model.html#beforeValidate">beforeValidate</a></li><li data-type='method'><a href="Model.html#build">build</a></li><li data-type='method'><a href="Model.html#buildKey">buildKey</a></li><li data-type='method'><a href="Model.html#create">create</a></li><li data-type='method'><a href="Model.html#getById">getById</a></li><li data-type='method'><a href="Model.html#getMulti">getMulti</a></li><li data-type='method'><a href="Model.html#remove">remove</a></li><li data-type='method'><a href="Model.html#removeHook">removeHook</a></li><li data-type='method'><a href="Model.html#runHooks">runHooks</a></li><li data-type='method'><a href="Model.html#toString">toString</a></li><li data-type='method'><a href="Model.html#touch">touch</a></li><li data-type='method'><a href="Model.html#unlock">unlock</a></li></ul></li><li><a href="ModelError.html">ModelError</a></li><li><a href="ModelManager.html">ModelManager</a><ul class='methods'><li data-type='method'><a href="ModelManager.html#add">add</a></li><li data-type='method'><a href="ModelManager.html#get">get</a></li><li data-type='method'><a href="ModelManager.html#getAll">getAll</a></li></ul></li><li><a href="StorageAdapter.html">StorageAdapter</a><ul class='methods'><li data-type='method'><a href="StorageAdapter.html#append">append</a></li><li data-type='method'><a href="StorageAdapter.html#bulkInsert">bulkInsert</a></li><li data-type='method'><a href="StorageAdapter.html#bulkInsertSync">bulkInsertSync</a></li><li data-type='method'><a href="StorageAdapter.html#bulkRemove">bulkRemove</a></li><li data-type='method'><a href="StorageAdapter.html#bulkRemoveSync">bulkRemoveSync</a></li><li data-type='method'><a href="StorageAdapter.html#counter">counter</a></li><li data-type='method'><a href="StorageAdapter.html#disconnect">disconnect</a></li><li data-type='method'><a href="StorageAdapter.html#enableN1ql">enableN1ql</a></li><li data-type='method'><a href="StorageAdapter.html#get">get</a></li><li data-type='method'><a href="StorageAdapter.html#getAndLock">getAndLock</a></li><li data-type='method'><a href="StorageAdapter.html#getAndTouch">getAndTouch</a></li><li data-type='method'><a href="StorageAdapter.html#getManager">getManager</a></li><li data-type='method'><a href="StorageAdapter.html#getReplica">getReplica</a></li><li data-type='method'><a href="StorageAdapter.html#insert">insert</a></li><li data-type='method'><a href="StorageAdapter.html#prepend">prepend</a></li><li data-type='method'><a href="StorageAdapter.html#query">query</a></li><li data-type='method'><a href="StorageAdapter.html#remove">remove</a></li><li data-type='method'><a href="StorageAdapter.html#replace">replace</a></li><li data-type='method'><a href="StorageAdapter.html#touch">touch</a></li><li data-type='method'><a href="StorageAdapter.html#unlock">unlock</a></li><li data-type='method'><a href="StorageAdapter.html#upsert">upsert</a></li></ul></li><li><a href="StorageError.html">StorageError</a></li><li><a href="StorageMultiError.html">StorageMultiError</a></li><li><a href="UUID4Key.html">UUID4Key</a><ul class='methods'><li data-type='method'><a href="UUID4Key.html#clone">clone</a></li><li data-type='method'><a href="UUID4Key.html#generate">generate</a></li><li data-type='method'><a href="UUID4Key.html#getId">getId</a></li><li data-type='method'><a href="UUID4Key.html#getOptions">getOptions</a></li><li data-type='method'><a href="UUID4Key.html#isGenerated">isGenerated</a></li><li data-type='method'><a href="UUID4Key.html#parse">parse</a></li><li data-type='method'><a href="UUID4Key.html#setId">setId</a></li><li data-type='method'><a href="UUID4Key.html#toString">toString</a></li></ul></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Modules</h3><ul><li><a href="Sanitizer_sanitizeData.html">Sanitizer:sanitizeData</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/hook.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var _           = require("lodash");
var Promise     = require('bluebird');
var HookError   = require('./error/hookError.js');

var HookType = Object.freeze({
    beforeValidate          : {type: 'beforeValidate', sync : true},
    afterValidate           : {type: 'afterValidate', sync : true},
    beforeCreate            : {type: 'beforeCreate'},
    afterCreate             : {type: 'afterCreate'},
    beforeDestroy           : {type: 'beforeDestroy'},
    afterDestroy            : {type: 'afterDestroy'},
    beforeRollback          : {type: 'beforeRollback'},
    afterRollback           : {type: 'afterRollback'},
    afterFailedRollback     : {type: 'afterFailedRollback', sync: true, params: 2},
    afterFailedIndexRemoval : {type: 'afterFailedIndexRemoval', sync: true},
    beforeUpdate            : {type: 'beforeUpdate'},
    afterUpdate             : {type: 'afterUpdate'},
    beforeGet               : {type: 'beforeGet'},
    afterGet                : {type: 'afterGet'}
});

var HookValues = [];//TODO cleaner solution
Object.keys(HookType).forEach(function(hookName) {
    HookValues.push(HookType[hookName]);
});

/**
 * @abstract
 * @constructor
 */
var Hook = {};

/**
 * addHook
 *
 * @param {string}   `hookType` - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 *
 * @name Hook#addHook
 * @function
 * @return this
 *
 */
Hook.addHook = function(hookType, fn, name) {
    if (HookValues.indexOf(HookType[hookType]) === -1) {
        throw new HookError('Attempted to attach hook of invalid hook type.');
    }

    if (typeof fn !== 'function') {
        throw new HookError('Attempted to register hook which is not a function');
    }

    this.options.hooks[hookType] = this.options.hooks[hookType] || [];
    var hooks = this.options.hooks[hookType];
    if (!name) {
        hooks.push(fn);
    } else {
        hooks.push({
            name: name,
            fn: fn
        });
    }

    return this;
}

/**
 * removeHook
 *
 * @param {string} hookType - see ./hookType.js for available types
 * @param {string} name - the identificator
 *
 * @name Hook#removeHook
 * @function
 * @return this
 *
 */
Hook.removeHook = function(hookType, name) {
    if (HookValues.indexOf(HookType[hookType]) === -1) {
        throw new HookError('Attempted to remove hook: ' + name + ' of invalid hook type.');
    }

    var hooks = (this.options.hooks &amp;&amp; this.options.hooks[hookType]) || [];
    this.options.hooks[hookType] = hooks.filter(function(value) {
        if (_.isPlainObject(value) &amp;&amp; value.name === name) {
            return false;
        }
        return true;
    });
    return this;
}

/**
 * runHooks
 *
 * additional arguments passed to the function will be passed to the hook function
 *
 * @param {string|Object} hookType
 *
 * @name Hook#runHooks
 * @function
 * @return Promise
 */
Hook.runHooks = function(hookType) {

    if (   (typeof hookType === 'string' &amp;&amp; !HookType.hasOwnProperty(hookType))
        &amp;&amp; HookValues.indexOf(hookType) === -1
       ) {
        throw new HookError('Attempted ro run hooks of invalid type.');
    }

    var hookOptions;

    if (typeof hookType === 'string') {
        hookOptions = HookType[hookType];
    } else {
        hookOptions = hookType;
        hookType = hookType.type;
    }

    var self = this;
    var hooks = this.options.hooks[hookType] || [];
    var numOfParams = hookOptions.params || 1;
    var fnArgs = Array.apply(this, arguments).slice(numOfParams);
    var promises = [];

    hooks = hooks.map(function(hook) {
        if (_.isPlainObject(hook)) {
            return hook.fn;
        }
        return hook;
    })

    //run hooks as sync functions if flagged as sync
    if (hookOptions.sync) {
        hooks.forEach(function(hook) {
            if (_.isPlainObject(hook)) hook = hook.fn;
            return hook.apply(self, fnArgs);
        });
        return;
    }

    // run hooks async
    return Promise.each(hooks, function (hook) {
        if (_.isPlainObject(hook)) {
            hook = hook.fn;
        }

        //to all hooks one argument is passed so far when called
        //if hook function has more that one arg we suppose that function
        //has defined callback function argument
        if (hookType &amp;&amp; hook.length > 1) {
            hook = Promise.promisify(hook, self);
        }

        return hook.apply(self, fnArgs);
    }).return();
}

module.exports = {
    /**
     */
    types: HookType,
    /**
     */
    applyTo: function(Model) {
        _.mixin(Model, Hook);
        _.mixin(Model.prototype, Hook);

        var allHooks = Object.keys(HookType);
        allHooks.forEach(function(hook) {
            Model.prototype[hook] = function(fn, name) {
                return this.addHook(hook, fn, name);
            };
        });
    }
}
/**
 * adds hook function to the stack
 * @name Hook#beforeValidate
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */

/**
 * adds hook function to the stack
 * @name Hook#afterValidate
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */

/**
 * adds hook function to the stack
 * @name Hook#beforeCreate
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */

/**
 * adds hook function to the stack
 * @name Hook#afterCreate
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */

/**
 * adds hook function to the stack
 * @name Hook#beforeDestroy
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */

/**
 * adds hook function to the stack
 * @name Hook#afterDestroy
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */

/**
 * adds hook function to the stack
 * @name Hook#beforeRollback
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */

/**
 * adds hook function to the stack
 * @name Hook#afterRollback
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */

/**
 * adds hook function to the stack
 * @name Hook#beforeValidate
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */

/**
 * adds hook function to the stack
 * @name Hook#afterFailedRollback
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */

/**
 * adds hook function to the stack
 * @name Hook#afterFailedIndexRemoval
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */

/**
 * adds hook function to the stack
 * @name Hook#beforeUpdate
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */

/**
 * adds hook function to the stack
 * @name Hook#afterUpdate
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */

/**
 * adds hook function to the stack
 * @name Hook#beforeGet
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */

/**
 * adds hook function to the stack
 * @name Hook#afterGet
 * @function
 * @param {string}   hookType - see ./hookType.js for available types
 * @param {function} fn - hook function
 * @param {string}   name - the identificator
 * @return {this}
 */
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu May 12 2016 14:32:23 GMT+0000 (UTC) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
