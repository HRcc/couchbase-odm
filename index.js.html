<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-1.gettingStarted.html">Getting Started</a></li><li><a href="tutorial-2.schemaDefinitionGuide.html">Model schema definition</a></li><li><a href="tutorial-3.quering.html">Quering</a></li><li><a href="tutorial-4.instances.html">Instances</a></li><li><a href="tutorial-5.hooks.html">Hooks</a></li><li><a href="tutorial-6.errors.html">Errors</a></li><li><a href="tutorial-7.customizingDocumentsKey.html">Customizing Document's Key</a></li></ul><h3>Classes</h3><ul><li><a href="CouchbaseODM.html">CouchbaseODM</a><ul class='methods'><li data-type='method'><a href="CouchbaseODM.html#define">define</a></li></ul></li><li><a href="Document.html">Document</a><ul class='methods'><li data-type='method'><a href="Document.html#getCAS">getCAS</a></li><li data-type='method'><a href="Document.html#getData">getData</a></li><li data-type='method'><a href="Document.html#getGeneratedKey">getGeneratedKey</a></li><li data-type='method'><a href="Document.html#getKey">getKey</a></li><li data-type='method'><a href="Document.html#getSerializedData">getSerializedData</a></li><li data-type='method'><a href="Document.html#getStorageAdapter">getStorageAdapter</a></li><li data-type='method'><a href="Document.html#hasCAS">hasCAS</a></li><li data-type='method'><a href="Document.html#insert">insert</a></li><li data-type='method'><a href="Document.html#remove">remove</a></li><li data-type='method'><a href="Document.html#replace">replace</a></li><li data-type='method'><a href="Document.html#setCAS">setCAS</a></li><li data-type='method'><a href="Document.html#setData">setData</a></li><li data-type='method'><a href="Document.html#setKey">setKey</a></li><li data-type='method'><a href="Document.html#touch">touch</a></li></ul></li><li><a href="DocumentError.html">DocumentError</a></li><li><a href="Hook.html">Hook</a><ul class='methods'><li data-type='method'><a href="Hook.html#addHook">addHook</a></li><li data-type='method'><a href="Hook.html#afterCreate">afterCreate</a></li><li data-type='method'><a href="Hook.html#afterDestroy">afterDestroy</a></li><li data-type='method'><a href="Hook.html#afterFailedIndexRemoval">afterFailedIndexRemoval</a></li><li data-type='method'><a href="Hook.html#afterFailedRollback">afterFailedRollback</a></li><li data-type='method'><a href="Hook.html#afterGet">afterGet</a></li><li data-type='method'><a href="Hook.html#afterRollback">afterRollback</a></li><li data-type='method'><a href="Hook.html#afterUpdate">afterUpdate</a></li><li data-type='method'><a href="Hook.html#afterValidate">afterValidate</a></li><li data-type='method'><a href="Hook.html#beforeCreate">beforeCreate</a></li><li data-type='method'><a href="Hook.html#beforeDestroy">beforeDestroy</a></li><li data-type='method'><a href="Hook.html#beforeGet">beforeGet</a></li><li data-type='method'><a href="Hook.html#beforeRollback">beforeRollback</a></li><li data-type='method'><a href="Hook.html#beforeUpdate">beforeUpdate</a></li><li data-type='method'><a href="Hook.html#beforeValidate">beforeValidate</a></li><li data-type='method'><a href="Hook.html#beforeValidate">beforeValidate</a></li><li data-type='method'><a href="Hook.html#removeHook">removeHook</a></li><li data-type='method'><a href="Hook.html#runHooks">runHooks</a></li></ul></li><li><a href="HookError.html">HookError</a></li><li><a href="IncrementalKey.html">IncrementalKey</a><ul class='methods'><li data-type='method'><a href="IncrementalKey.html#clone">clone</a></li><li data-type='method'><a href="IncrementalKey.html#generate">generate</a></li><li data-type='method'><a href="IncrementalKey.html#getId">getId</a></li><li data-type='method'><a href="IncrementalKey.html#getOptions">getOptions</a></li><li data-type='method'><a href="IncrementalKey.html#isGenerated">isGenerated</a></li><li data-type='method'><a href="IncrementalKey.html#parse">parse</a></li><li data-type='method'><a href="IncrementalKey.html#setId">setId</a></li><li data-type='method'><a href="IncrementalKey.html#toString">toString</a></li></ul></li><li><a href="Instance.html">Instance</a><ul class='methods'><li data-type='method'><a href="Instance.html#clone">clone</a></li><li data-type='method'><a href="Instance.html#cloneData">cloneData</a></li><li data-type='method'><a href="Instance.html#destroy">destroy</a></li><li data-type='method'><a href="Instance.html#getCAS">getCAS</a></li><li data-type='method'><a href="Instance.html#getData">getData</a></li><li data-type='method'><a href="Instance.html#getGeneratedKey">getGeneratedKey</a></li><li data-type='method'><a href="Instance.html#getKey">getKey</a></li><li data-type='method'><a href="Instance.html#getSerializedData">getSerializedData</a></li><li data-type='method'><a href="Instance.html#getStorageAdapter">getStorageAdapter</a></li><li data-type='method'><a href="Instance.html#hasCAS">hasCAS</a></li><li data-type='method'><a href="Instance.html#insert">insert</a></li><li data-type='method'><a href="Instance.html#refresh">refresh</a></li><li data-type='method'><a href="Instance.html#remove">remove</a></li><li data-type='method'><a href="Instance.html#replace">replace</a></li><li data-type='method'><a href="Instance.html#sanitize">sanitize</a></li><li data-type='method'><a href="Instance.html#save">save</a></li><li data-type='method'><a href="Instance.html#setCAS">setCAS</a></li><li data-type='method'><a href="Instance.html#setData">setData</a></li><li data-type='method'><a href="Instance.html#setKey">setKey</a></li><li data-type='method'><a href="Instance.html#toJSON">toJSON</a></li><li data-type='method'><a href="Instance.html#touch">touch</a></li><li data-type='method'><a href="Instance.html#update">update</a></li></ul></li><li><a href="InstanceError.html">InstanceError</a></li><li><a href="Key.html">Key</a><ul class='methods'><li data-type='method'><a href="Key.html#generate">generate</a></li><li data-type='method'><a href="Key.html#getId">getId</a></li><li data-type='method'><a href="Key.html#getOptions">getOptions</a></li><li data-type='method'><a href="Key.html#isGenerated">isGenerated</a></li><li data-type='method'><a href="Key.html#parse">parse</a></li><li data-type='method'><a href="Key.html#setId">setId</a></li><li data-type='method'><a href="Key.html#toString">toString</a></li></ul></li><li><a href="KeyError.html">KeyError</a></li><li><a href="Model.html">Model</a><ul class='methods'><li data-type='method'><a href="Model.html#addHook">addHook</a></li><li data-type='method'><a href="Model.html#afterCreate">afterCreate</a></li><li data-type='method'><a href="Model.html#afterDestroy">afterDestroy</a></li><li data-type='method'><a href="Model.html#afterFailedIndexRemoval">afterFailedIndexRemoval</a></li><li data-type='method'><a href="Model.html#afterFailedRollback">afterFailedRollback</a></li><li data-type='method'><a href="Model.html#afterGet">afterGet</a></li><li data-type='method'><a href="Model.html#afterRollback">afterRollback</a></li><li data-type='method'><a href="Model.html#afterUpdate">afterUpdate</a></li><li data-type='method'><a href="Model.html#afterValidate">afterValidate</a></li><li data-type='method'><a href="Model.html#beforeCreate">beforeCreate</a></li><li data-type='method'><a href="Model.html#beforeDestroy">beforeDestroy</a></li><li data-type='method'><a href="Model.html#beforeGet">beforeGet</a></li><li data-type='method'><a href="Model.html#beforeRollback">beforeRollback</a></li><li data-type='method'><a href="Model.html#beforeUpdate">beforeUpdate</a></li><li data-type='method'><a href="Model.html#beforeValidate">beforeValidate</a></li><li data-type='method'><a href="Model.html#build">build</a></li><li data-type='method'><a href="Model.html#buildKey">buildKey</a></li><li data-type='method'><a href="Model.html#create">create</a></li><li data-type='method'><a href="Model.html#getById">getById</a></li><li data-type='method'><a href="Model.html#getMulti">getMulti</a></li><li data-type='method'><a href="Model.html#remove">remove</a></li><li data-type='method'><a href="Model.html#removeHook">removeHook</a></li><li data-type='method'><a href="Model.html#runHooks">runHooks</a></li><li data-type='method'><a href="Model.html#toString">toString</a></li><li data-type='method'><a href="Model.html#touch">touch</a></li><li data-type='method'><a href="Model.html#unlock">unlock</a></li></ul></li><li><a href="ModelError.html">ModelError</a></li><li><a href="ModelManager.html">ModelManager</a><ul class='methods'><li data-type='method'><a href="ModelManager.html#add">add</a></li><li data-type='method'><a href="ModelManager.html#get">get</a></li><li data-type='method'><a href="ModelManager.html#getAll">getAll</a></li></ul></li><li><a href="StorageAdapter.html">StorageAdapter</a><ul class='methods'><li data-type='method'><a href="StorageAdapter.html#append">append</a></li><li data-type='method'><a href="StorageAdapter.html#bulkInsert">bulkInsert</a></li><li data-type='method'><a href="StorageAdapter.html#bulkInsertSync">bulkInsertSync</a></li><li data-type='method'><a href="StorageAdapter.html#bulkRemove">bulkRemove</a></li><li data-type='method'><a href="StorageAdapter.html#bulkRemoveSync">bulkRemoveSync</a></li><li data-type='method'><a href="StorageAdapter.html#counter">counter</a></li><li data-type='method'><a href="StorageAdapter.html#disconnect">disconnect</a></li><li data-type='method'><a href="StorageAdapter.html#enableN1ql">enableN1ql</a></li><li data-type='method'><a href="StorageAdapter.html#get">get</a></li><li data-type='method'><a href="StorageAdapter.html#getAndLock">getAndLock</a></li><li data-type='method'><a href="StorageAdapter.html#getAndTouch">getAndTouch</a></li><li data-type='method'><a href="StorageAdapter.html#getManager">getManager</a></li><li data-type='method'><a href="StorageAdapter.html#getReplica">getReplica</a></li><li data-type='method'><a href="StorageAdapter.html#insert">insert</a></li><li data-type='method'><a href="StorageAdapter.html#prepend">prepend</a></li><li data-type='method'><a href="StorageAdapter.html#query">query</a></li><li data-type='method'><a href="StorageAdapter.html#remove">remove</a></li><li data-type='method'><a href="StorageAdapter.html#replace">replace</a></li><li data-type='method'><a href="StorageAdapter.html#touch">touch</a></li><li data-type='method'><a href="StorageAdapter.html#unlock">unlock</a></li><li data-type='method'><a href="StorageAdapter.html#upsert">upsert</a></li></ul></li><li><a href="StorageError.html">StorageError</a></li><li><a href="StorageMultiError.html">StorageMultiError</a></li><li><a href="UUID4Key.html">UUID4Key</a><ul class='methods'><li data-type='method'><a href="UUID4Key.html#clone">clone</a></li><li data-type='method'><a href="UUID4Key.html#generate">generate</a></li><li data-type='method'><a href="UUID4Key.html#getId">getId</a></li><li data-type='method'><a href="UUID4Key.html#getOptions">getOptions</a></li><li data-type='method'><a href="UUID4Key.html#isGenerated">isGenerated</a></li><li data-type='method'><a href="UUID4Key.html#parse">parse</a></li><li data-type='method'><a href="UUID4Key.html#setId">setId</a></li><li data-type='method'><a href="UUID4Key.html#toString">toString</a></li></ul></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Modules</h3><ul><li><a href="Sanitizer_sanitizeData.html">Sanitizer:sanitizeData</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var _  = require("lodash");

var InstanceError           = require("./lib/error/instanceError.js");
var DocumentError           = require("./lib/error/documentError.js");
var KeyError                = require("./lib/error/keyError.js");
var ModelError              = require("./lib/error/modelError.js");
var StorageMultiError       = require("./lib/error/storageMultiError.js");
var StorageError            = require("./lib/error/storageError.js");
var ValidationError         = require("./lib/error/validationError.js");


var RefDocKey      = require("./lib/key/refDocKey.js");
var IncrementalKey = require("./lib/key/incrementalKey.js");
var UUID4Key       = require("./lib/key/uuid4Key.js");
var Key            = require("./lib/key/key.js");

var Operation      = require("./lib/operation.js");
var DataTypes      = require("./lib/dataType.js").types;
var Instance       = require("./lib/instance.js");
var Document       = require("./lib/document.js");
var Model          = require("./lib/model.js");
var ModelManager   = require("./lib/modelManager.js");
var Sanitizer      = require("./lib/sanitizer.js");
var StorageAdapter = require("./lib/storageAdapter.js");
var Hook           = require("./lib/hook.js");

/**
 * CouchbaseODM
 *
 * main enterance to the couchbase-odm
 *
 * @constructor
 * @param {Object}  [options]
 * @param {Bucket}  options.bucket - must be instance of Couchbase.Bucket (from official nodejs couchbase sdk)
 * @param {Key}     [options.key={UUID4Key}] - The strategy used for document's `key` generation. Must inherit from base `Key` class
 * @param {boolean} [options.timestamps=true] - Adds automatically handled timestamp schema properties: `created_at`, `updated_at` and if `paranoid` option is true, `deleted_at` property
 * @param {boolean} [options.paranoid=false] - if `true` is set, a document is not actually removed from `bucket` but rather `deleted_at` flag on the document is set. aka. `soft delete`
 * @param {boolean} [options.camelCase=false] - if `true` is set, camel case notation is used for document's internal properties.
 * @param {Object}  [options.schemaSettings] - allows to modify default values used for document's `key` generation and document's property names handled by ODM
 * @param {Object}  [options.schemaSettings.key]
 * @param {string}  [options.schemaSettings.key.prefix=defaults to Model's name] - you most likely do not want to set default value at `CouchbaseODM` constructor level
 * @param {string}  [options.schemaSettings.key.postfix=""]
 * @param {string}  [options.schemaSettings.key.delimiter=""]
 * @param {Object}  [options.schemaSettings.doc]
 * @param {string}  [options.schemaSettings.doc.idPropertyName="_id"] - `_id` contains generated id of document (not whole document's key)
 * @param {string}  [options.schemaSettings.doc.typePropertyName="_type"] - `_type` contains the name of a Model
 * @param {Object}  [options.hooks] - allows to add one or more hooks of a hook type (eg. `afterValidate`)
 * @param {Object}  [options.classMethods] - custom method definitions which are bound to a Model.
 * @param {Object}  [options.instanceMethods] - custom method definitions which are bound to a Instance.
 * @param {Object}  [options.indexes]
 * @param {Object}  [options.indexes.refDocs] - Global reference document definitions. Refdoc is a document which reference parent document with its string value(=key). See {@tutorial 3b.refDocIndexes} tutorial for more details
 */
function CouchbaseODM(options) {

    var defaults = {
        key: UUID4Key,
        schemaSettings : {
            key: {
                postfix: "",
                delimiter: "_"
            },
            doc: {
                idPropertyName: "_id",
                typePropertyName: "_type"
            }
        },
        hooks: {},
        timestamps: true,
        paranoid: false,
        camelCase: false,
        classMethods: {},
        instanceMethods: {},
        bucket: null,
        indexes: {
            refDocs: {}
        }
    };

    /**
     * @instance
     * @type {ModelManager}
     */
    this.modelManager = new ModelManager();
    this.options = _.merge(defaults, options || {});

    //Transform mapped hooks of type to collection of hooks if not collection already
    Object.keys(this.options.hooks || {}).forEach(function(hookType) {
        if (!(this.options.hooks[hookType] instanceof Array)) {
            this.options.hooks[hookType] = [this.options.hooks[hookType]];
        }
    });
}

/**
 * attach hooks methods to Model, Model.prototype
 */
Hook.applyTo(CouchbaseODM);

/**
 * define
 *
 * builds new Model representing a document(s) in bucket
 *
 * @param {string} name - name of the model
 * @param {Object} schema - data schema definition
 * @param {Object} [options] - see {@link Model} for available options
 * @return {Model}
 */
CouchbaseODM.prototype.define = function(name, schema, options) {

    options = options || {};
    //Transform mapped hooks of type to collection of hooks if not collection already
    Object.keys(options.hooks || {}).forEach(function(hookType) {
        if (!(options.hooks[hookType] instanceof Array)) {
            options.hooks[hookType] = [options.hooks[hookType]];
        }
    });

    options = _.merge({}, this.options, options || {});

    var model = new Model(name, schema, options);

    model.$init(this.modelManager);

    this.modelManager.add(model);

    return model;
}

/**
 * @typedef ErrorList
 * @type {Object}
 * @property {InstanceError}     InstanceError
 * @property {ModelError}        ModelError
 * @property {DocumentError}     DocumentError
 * @property {KeyError}          KeyError
 * @property {StorageError}      StorageError
 * @property {StorageMultiError} StorageMultiError
 * @property {ValidationError}   ValidationError
 */

/**
 * @name CouchbaseODM.errors
 * @type {ErrorList}
 */
CouchbaseODM.errors = {
    InstanceError     : InstanceError,
    ModelError        : ModelError,
    DocumentError     : DocumentError,
    KeyError          : KeyError,
    StorageError      : StorageError,
    StorageMultiError : StorageMultiError,
    ValidationError   : ValidationError,
}

CouchbaseODM.Key            = Key;
CouchbaseODM.UUID4Key       = UUID4Key;
CouchbaseODM.IncrementalKey = IncrementalKey;
CouchbaseODM.RefDocKey      = RefDocKey;
CouchbaseODM.DataTypes      = DataTypes;
CouchbaseODM.Operation      = Operation;
CouchbaseODM.Instance       = Instance;
CouchbaseODM.Document       = Document;
CouchbaseODM.Model          = Model;
CouchbaseODM.ModelManager   = ModelManager;
CouchbaseODM.Sanitizer      = Sanitizer;
CouchbaseODM.StorageAdapter = StorageAdapter;
CouchbaseODM.Hook           = Hook;

module.exports = CouchbaseODM;

/**
 * @name CouchbaseODM.Key
 * @type Key
 */

/**
 * @name CouchbaseODM.UUID4Key
 * @type UUID4Key
 */

/**
 * @name CouchbaseODM.IncrementalKey
 * @type IncrementalKey
 */

/**
 * @name CouchbaseODM.RefDocKey
 * @type RefDocKey
 */

/**
 * @name CouchbaseODM.DataTypes
 * @type DataTypes
 */

/**
 * @name CouchbaseODM.Operation
 * @type Operation
 */

/**
 * @name CouchbaseODM.Instance
 * @type Instance
 */

/**
 * @name CouchbaseODM.Document
 * @type Document
 */

/**
 * @name CouchbaseODM.Model
 * @type Model
 */

/**
 * @name CouchbaseODM.ModelManager
 * @type ModelManager
 */

/**
 * @name CouchbaseODM.Sanitizer
 * @type Sanitizer
 */

/**
 * @name CouchbaseODM.StorageAdapter
 * @type StorageAdapter
 */

/**
 * @name CouchbaseODM.Hook
 * @type Hook
 */

</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu May 12 2016 11:17:28 GMT+0000 (UTC) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
